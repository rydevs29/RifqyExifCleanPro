<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifqyExifCleanPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/piexifjs@1.0.6/piexif.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Outfit"', 'sans-serif'] },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-up': 'fadeUp 0.5s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        fadeUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: #1e293b;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .btn-press:active { transform: scale(0.97); }
        /* Agar teks panjang otomatis jadi titik-titik (...) */
        .text-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* Batas lebar teks */
            display: inline-block;
        }
        @media (max-width: 640px) {
            .text-truncate { max-width: 140px; } /* Lebih pendek di HP */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 selection:bg-indigo-500 selection:text-white">

    <div class="text-center mb-8 animate-fade-up">
        <h1 class="text-4xl font-bold text-white mb-1 drop-shadow-lg">RifqyExif<span class="text-indigo-300">CleanPro</span></h1>
        <p class="text-indigo-100/80 text-sm font-light">Privasi Foto Aman dalam Sekejap.</p>
    </div>

    <div class="glass-card w-full max-w-lg rounded-3xl overflow-hidden relative min-h-[420px] transition-all duration-500 animate-fade-up">
        
        <div id="stateUpload" class="absolute inset-0 flex flex-col p-8 z-10">
            <div id="dropZone" class="flex-1 border-2 border-dashed border-slate-300 rounded-2xl flex flex-col items-center justify-center cursor-pointer group hover:border-indigo-500 hover:bg-indigo-50/30 transition-all duration-300 relative">
                <div class="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 animate-float">
                    <i class="ph-fill ph-images text-3xl text-indigo-600"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-700">Upload Foto JPG</h3>
                <p class="text-slate-400 text-xs mt-1">Klik atau tarik file ke sini</p>
            </div>
            <input type="file" id="fileInput" accept="image/jpeg, image/jpg" class="hidden">
        </div>

        <div id="stateReview" class="absolute inset-0 bg-white flex flex-col p-0 opacity-0 pointer-events-none transform translate-y-10 transition-all duration-500 z-20">
            <div class="relative h-40 w-full bg-slate-900 overflow-hidden">
                <img id="previewImg" class="w-full h-full object-cover opacity-70" alt="Preview">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 to-transparent flex items-end p-5">
                    <div class="w-full flex justify-between items-end">
                        <div>
                            <p class="text-white/60 text-[10px] font-bold uppercase tracking-wider mb-0.5">Analisis Keamanan</p>
                            <h2 id="securityStatusText" class="text-white font-bold text-lg flex items-center gap-2">Memeriksa...</h2>
                        </div>
                        <button onclick="location.reload()" class="bg-white/20 hover:bg-white/30 text-white p-1.5 rounded-full backdrop-blur-sm transition-all btn-press"><i class="ph-bold ph-x"></i></button>
                    </div>
                </div>
            </div>

            <div class="flex-1 p-5 overflow-y-auto bg-slate-50 space-y-2">
                
                <div id="cardGPS" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3 transition-colors">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-500">
                        <i class="ph-fill ph-map-pin text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Lokasi</p>
                        <p id="metaGPS" class="text-sm font-semibold text-slate-700 text-truncate">Menunggu...</p>
                    </div>
                    <div id="iconGPSStatus"></div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-500">
                        <i class="ph-fill ph-camera text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Kamera / HP</p>
                        <p id="metaDevice" class="text-sm font-semibold text-slate-700 text-truncate">-</p>
                    </div>
                </div>

                <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-500">
                        <i class="ph-fill ph-calendar text-lg"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Waktu</p>
                        <p id="metaDate" class="text-sm font-semibold text-slate-700 text-truncate">-</p>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-slate-100">
                <button id="btnClean" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-indigo-200 transition-all btn-press flex items-center justify-center gap-2">
                    <i class="ph-bold ph-magic-wand text-lg"></i>
                    <span>Bersihkan Metadata</span>
                </button>
            </div>
        </div>

        <div id="stateSuccess" class="absolute inset-0 bg-white flex flex-col items-center justify-center p-8 opacity-0 pointer-events-none transition-all duration-500 z-30">
            <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mb-4 animate-scale-in">
                <i class="ph-fill ph-shield-check text-4xl text-emerald-600"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Berhasil Dibersihkan!</h2>
            <p class="text-slate-500 text-center text-sm mb-6">Data lokasi dan identitas perangkat telah dihapus.</p>
            <a id="downloadLink" href="#" download="RifqyClean_Image.jpg" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-xl transition-all btn-press flex items-center justify-center gap-2 mb-3">
                <i class="ph-bold ph-download-simple"></i> Download
            </a>
            <button onclick="location.reload()" class="text-slate-400 hover:text-indigo-600 text-xs font-medium py-2">Proses foto lain</button>
        </div>
    </div>

    <footer class="mt-6 text-white/40 text-[10px] text-center uppercase tracking-widest">&copy; 2025 RifqyExifCleanPro</footer>

    <script>
        // --- Setup DOM ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const previewImg = document.getElementById('previewImg');
        const btnClean = document.getElementById('btnClean');
        const downloadLink = document.getElementById('downloadLink');

        const stateUpload = document.getElementById('stateUpload');
        const stateReview = document.getElementById('stateReview');
        const stateSuccess = document.getElementById('stateSuccess');

        const metaDevice = document.getElementById('metaDevice');
        const metaGPS = document.getElementById('metaGPS');
        const metaDate = document.getElementById('metaDate');
        const cardGPS = document.getElementById('cardGPS');
        const iconGPSStatus = document.getElementById('iconGPSStatus');
        const securityStatusText = document.getElementById('securityStatusText');

        let originalDataURL = "";

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }));
        dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));

        function handleFiles(files) {
            const file = files[0];
            if (!file || !file.type.match('image/jpe?g')) { alert("Hanya format JPG/JPEG."); return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                originalDataURL = e.target.result;
                previewImg.src = originalDataURL;
                
                // Reset UI Text
                metaGPS.innerText = "Menganalisis...";
                metaDevice.innerText = "-";
                metaDate.innerText = "-";
                
                // Transition UI
                stateUpload.style.opacity = '0'; stateUpload.style.pointerEvents = 'none';
                stateReview.style.opacity = '1'; stateReview.style.pointerEvents = 'auto'; stateReview.style.transform = 'translateY(0)';
                
                analyzeMetadata(originalDataURL);
            };
            reader.readAsDataURL(file);
        }

        // --- Helper: Convert DMS to Decimal ---
        function dmsToDecimal(dms, ref) {
            if(!dms || dms.length < 3) return null;
            const d = dms[0][0] / dms[0][1];
            const m = dms[1][0] / dms[1][1];
            const s = dms[2][0] / dms[2][1];
            let decimal = d + m / 60 + s / 3600;
            if (ref === "S" || ref === "W") decimal = decimal * -1;
            return decimal;
        }

        // --- Helper: Clean Text ---
        function cleanString(str) {
            if (!str) return "-";
            // Remove null bytes and trim
            return str.replace(/\0/g, '').trim() || "-";
        }

        // --- Main Logic ---
        function analyzeMetadata(dataURL) {
            try {
                const exifObj = piexif.load(dataURL);
                
                // 1. Device (Clean & Assign)
                const rawModel = exifObj["0th"][piexif.ImageIFD.Model];
                metaDevice.innerText = rawModel ? cleanString(rawModel) : "Tidak ada data";

                // 2. Date
                const rawDate = exifObj["Exif"][piexif.ExifIFD.DateTimeOriginal];
                metaDate.innerText = rawDate ? cleanString(rawDate) : "Tidak ada data";

                // 3. GPS Analysis
                const gps = exifObj["GPS"];
                let lat = null, lon = null;
                let hasGPSData = false;

                // Cek apakah GPS tag ada DAN valid
                if (gps && gps[piexif.GPSIFD.GPSLatitude] && gps[piexif.GPSIFD.GPSLongitude]) {
                    lat = dmsToDecimal(gps[piexif.GPSIFD.GPSLatitude], gps[piexif.GPSIFD.GPSLatitudeRef]);
                    lon = dmsToDecimal(gps[piexif.GPSIFD.GPSLongitude], gps[piexif.GPSIFD.GPSLongitudeRef]);
                    if (lat !== null && lon !== null) hasGPSData = true;
                }

                if (hasGPSData) {
                    // KASUS: ADA GPS
                    securityStatusText.innerHTML = `<span class="text-rose-200">⚠️ Metadata Ditemukan</span>`;
                    metaGPS.innerHTML = `<span class="text-rose-600 animate-pulse">Melacak koordinat...</span>`;
                    iconGPSStatus.innerHTML = `<i class="ph-fill ph-warning text-rose-500 text-xl"></i>`;
                    cardGPS.className = "bg-rose-50 p-3 rounded-xl shadow-sm border border-rose-200 flex items-center gap-3";

                    // Ambil Nama Kota
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                        .then(res => res.json())
                        .then(data => {
                            let loc = data.address.city || data.address.town || data.address.district || "Lokasi Terdeteksi";
                            // Tampilkan lokasi, class 'text-truncate' akan memotong jika kepanjangan
                            metaGPS.innerHTML = `<span class="text-rose-700 font-bold" title="${loc}">${loc}</span>`;
                        })
                        .catch(() => {
                            metaGPS.innerHTML = `<span class="text-rose-700 font-bold">Koordinat Ada (Offline)</span>`;
                        });

                } else {
                    // KASUS: TIDAK ADA GPS (AMAN)
                    securityStatusText.innerHTML = `<span class="text-emerald-200">✅ File Aman</span>`;
                    metaGPS.innerHTML = `<span class="text-emerald-600 font-bold">Tidak ada data lokasi</span>`;
                    iconGPSStatus.innerHTML = `<i class="ph-fill ph-check-circle text-emerald-500 text-xl"></i>`;
                    cardGPS.className = "bg-white p-3 rounded-xl shadow-sm border border-emerald-100 flex items-center gap-3";
                }

            } catch (err) {
                console.error(err);
                metaGPS.innerText = "Error membaca data";
            }
        }

        // --- Action: Clean ---
        btnClean.addEventListener('click', () => {
            const btnOriginal = btnClean.innerHTML;
            btnClean.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-lg"></i> <span>Memproses...</span>`;
            
            setTimeout(() => {
                const cleanDataURL = piexif.remove(originalDataURL);
                downloadLink.href = cleanDataURL;
                
                stateReview.style.opacity = '0'; stateReview.style.pointerEvents = 'none'; stateReview.style.transform = 'translateY(-20px)';
                stateSuccess.style.opacity = '1'; stateSuccess.style.pointerEvents = 'auto';
                
                btnClean.innerHTML = btnOriginal;
            }, 600);
        });
    </script>
</body>
</html>
